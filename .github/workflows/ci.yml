name: 3DPhysicsEngine CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libyaml-cpp-dev gcc g++ gcovr jq bc git

      - name: Set environment variables
        run: |
          echo "CC=gcc" >> $GITHUB_ENV
          echo "CXX=g++" >> $GITHUB_ENV

      - name: Configure project
        run: |
          cmake -S . -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DTESTS=ON \
            -DCOVERAGE=ON

      - name: Build
        run: cmake --build build -- -j$(nproc)

      - name: Run tests
        run: ctest --test-dir build --output-on-failure -j$(nproc)

      - name: Generate coverage report
        run: |
          mkdir -p coverage
          # Generate JSON coverage report
          gcovr -r . --json coverage/coverage.json

          # Extract numeric coverage (0â€“1 float) and convert to percentage
          total_coverage=$(jq '.line_coverage' coverage/coverage.json)
          if [[ -z "$total_coverage" || "$total_coverage" == "null" ]]; then
            echo "Error: could not extract line_coverage from gcovr output"
            cat coverage/coverage.json
            exit 1
          fi

          # Convert float (e.g., 0.87) to percentage (87)
          percent=$(awk "BEGIN {print int($total_coverage * 100)}")

          # Determine badge color
          color="red"
          if (( $(echo "$percent >= 90" | bc -l) )); then color="brightgreen";
          elif (( $(echo "$percent >= 75" | bc -l) )); then color="green";
          elif (( $(echo "$percent >= 50" | bc -l) )); then color="yellow";
          fi

          # Generate JSON badge metadata (for Shields.io-style)
          echo "{\"schemaVersion\":1,\"label\":\"coverage\",\"message\":\"${percent}%\",\"color\":\"${color}\"}" > coverage/coverage-badge.json

          # Generate simple SVG badge
          cat <<EOF > coverage/badge.svg
          <svg xmlns="http://www.w3.org/2000/svg" width="120" height="20">
            <rect width="70" height="20" fill="#555"/>
            <rect x="70" width="50" height="20" fill="${color}"/>
            <text x="35" y="14" fill="#fff" font-family="Verdana" font-size="11" text-anchor="middle">coverage</text>
            <text x="95" y="14" fill="#fff" font-family="Verdana" font-size="11" text-anchor="middle">${percent}%</text>
          </svg>
          EOF
